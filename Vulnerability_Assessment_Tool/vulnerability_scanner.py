import subprocess
import json
from rich.console import Console

console = Console()

def run_safety_check(filepath):
    """Run the 'safety' tool to check for known vulnerabilities."""
    try:
        result = subprocess.run(['safety', 'check', '--file', filepath, '--json'], capture_output=True, text=True)
        
        if result.returncode != 0:
            console.print("[bold red]Failed to run safety. Please ensure it's installed correctly.[/bold red]")
            return []
        
        vulnerabilities = result.stdout
        return parse_vulnerabilities(vulnerabilities)
    
    except Exception as e:
        console.print(f"[bold red]Error occurred: {e}[/bold red]")
        return []

def parse_vulnerabilities(vulnerabilities_json):
    """Parse the JSON vulnerabilities output into a dictionary format."""
    vulnerabilities = json.loads(vulnerabilities_json)
    
    if len(vulnerabilities) == 0:
        return []
    
    parsed_vulnerabilities = []
    
    for vulnerability in vulnerabilities:
        parsed_vulnerabilities.append({
            'name': vulnerability.get('name', 'N/A'),
            'version': vulnerability.get('version', 'N/A'),
            'affected_versions': vulnerability.get('affected_versions', 'N/A'),
            'vuln_id': vulnerability.get('vuln_id', 'N/A'),
            'advisory': vulnerability.get('advisory', 'N/A')
        })
    
    return parsed_vulnerabilities
